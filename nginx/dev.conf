server {
  listen 80;
  server_name _;

  # Reduce info exposure
  server_tokens off;

  # Allow large payloads for uploads if needed
  client_max_body_size 100m;

  # Proxy defaults
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 600s;

  # --- API to Nest controller ---
  # Handle bare /api (no trailing slash)
  location = /api {
    proxy_pass http://controller1:3000/;
  }
  location /api/ {
    # Strip the /api prefix when forwarding
    rewrite ^/api/?(.*)$ /$1 break;
    proxy_pass http://controller1:3000;
  }

  # --- Everything else to Nuxt dev server ---
  location / {
    proxy_pass http://frontend:3000;
  }

  # --- MinIO proxy to bypass browser CORS for presigned URLs ---
  # Use by rewriting presigned URL like:
  #   http://localhost:9000/bucket/key?... -> /s3/bucket/key?...
  location /s3/ {
    rewrite ^/s3/(.*)$ /$1 break;
    proxy_pass http://minio:9000;
    # Preserve the original signed Host header expected by MinIO signature
    proxy_set_header Host "localhost:9000";
  }
}
